<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Scheduling Jobs for Maximum Efficiency - Part 2 - Matthew Crews</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:title" content="Scheduling Jobs for Maximum Efficiency - Part 2"><meta property="og:description" content="In my previous post I introduced a scheduling problem where I needed to assign jobs to machines to achieve the maximum efficiency. We say efficiency is calculated as the number of times a machine must change the job-type it is working on. I want to continue exploring this problem by adding some nuance.
Note: Full code for this post can be found here
Not Too Many Bad Jobs As my conversation continued with my friend regarding this problem a new constraint came up."><meta property="og:type" content="article"><meta property="og:url" content="https://matthewcrews.com/blog/2021/01/2021-01-28/"><meta property="og:image" content="https://matthewcrews.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-01-28T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-23T09:34:35-07:00"><meta property="og:site_name" content="Matthew Crews"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://matthewcrews.com/logo.png"><meta name=twitter:title content="Scheduling Jobs for Maximum Efficiency - Part 2"><meta name=twitter:description content="In my previous post I introduced a scheduling problem where I needed to assign jobs to machines to achieve the maximum efficiency. We say efficiency is calculated as the number of times a machine must change the job-type it is working on. I want to continue exploring this problem by adding some nuance.
Note: Full code for this post can be found here
Not Too Many Bad Jobs As my conversation continued with my friend regarding this problem a new constraint came up."><meta name=application-name content="Mathew Crews"><meta name=apple-mobile-web-app-title content="Mathew Crews"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://matthewcrews.com/blog/2021/01/2021-01-28/><link rel=prev href=https://matthewcrews.com/blog/2021/01/2021-01-25/><link rel=next href=https://matthewcrews.com/blog/2021/02/2021-02-04/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Scheduling Jobs for Maximum Efficiency - Part 2","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/matthewcrews.com\/blog\/2021\/01\/2021-01-28\/"},"image":[{"@type":"ImageObject","url":"https:\/\/matthewcrews.com\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"blog","wordcount":1692,"url":"https:\/\/matthewcrews.com\/blog\/2021\/01\/2021-01-28\/","datePublished":"2021-01-28T00:00:00+00:00","dateModified":"2023-05-23T09:34:35-07:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/matthewcrews.com\/images\/fast_fsharp_avatar.png"},"author":{"@type":"Person","name":"Matthew Crews"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">Scheduling Jobs for Maximum Efficiency - Part 2</h1><div class=content id=content><p>In my previous <a href=/blog/2021/01/2021-01-25/ rel>post</a> I introduced a scheduling problem where I needed to assign jobs to machines to achieve the maximum efficiency. We say efficiency is calculated as the number of times a machine must change the job-type it is working on. I want to continue exploring this problem by adding some nuance.</p><blockquote><p><strong>Note</strong>: Full code for this post can be found <a href=https://github.com/matthewcrews/modelmondays/blob/main/2021-01-22-MachineAllocation/2021-01-28-MachineAllocationPercentConstraints.fsx target=_blank rel="noopener noreffer">here</a></p></blockquote><h2 id=not-too-many-bad-jobs>Not Too Many Bad Jobs</h2><p>As my conversation continued with my friend regarding this problem a new constraint came up. It turns out there is a fourth job-type, let&rsquo;s call it job-type D, that can cause significant wear on a machine if it is run for too long. He wanted to add a constraint to the problem which would limit that amount of job-type D assigned to any given machine. In his case, he wanted a machine to have no more than 50% of the total work assigned to it to be of job-type D. Fortunately this is a relatively simple update to our model.</p><h2 id=refactoring-the-domain>Refactoring the Domain</h2><p>The great thing about F# is that it is easy to refactor our domain. In our case the <code>Job</code> type and the <code>Machine</code> type don&rsquo;t need to change. What does need to be updated is the <code>JobType</code> type. We will add another case to the discriminated union to represent job-type D. I have also decided to do some refactoring and clean up how the code is organized. We are also going to move all the type definitions into their own Module.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>module</span> <span class=nn>Types</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The Domain
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>[&lt;</span><span class=n>RequireQualifiedAccess</span><span class=o>&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=k>type</span> <span class=nc>JobType</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>A</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>B</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>C</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>D</span> <span class=c1>// This is the new case we have added
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>type</span> <span class=nc>Job</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Id</span> <span class=o>:</span> <span class=n>int</span>
</span></span><span class=line><span class=cl>        <span class=n>JobType</span> <span class=o>:</span> <span class=n>JobType</span>
</span></span><span class=line><span class=cl>        <span class=n>Size</span> <span class=o>:</span> <span class=kt>float</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>with</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=n>this</span><span class=p>.</span><span class=nf>ToString</span> <span class=bp>()</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=o>$</span><span class=s>&#34;Job_{this.Id}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>type</span> <span class=nc>Machine</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Id</span> <span class=o>:</span> <span class=n>int</span>
</span></span><span class=line><span class=cl>        <span class=n>JobTypes</span> <span class=o>:</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>JobType</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>with</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=n>this</span><span class=p>.</span><span class=nf>ToString</span> <span class=bp>()</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=o>$</span><span class=s>&#34;Machine_{this.Id}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Next, we need to adjust our data generation. Again, we are going to do some code cleanup and move all the code for generating random jobs and machines into its own module. We are adjusting two thing from the <a href=/blog/2021/01/2021-01-25/ rel>previous post</a>. The <code>jobTypes</code> Array had the new <code>JobType</code> case. We are also going to adjust the <code>jobTypeSets</code>. This is the possible job qualifications for a machine. In our new problem, job-type A is the most difficult and therefore fewer machines are qualified. All machines are capable of job-type D, even though it is not preferred.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>module</span> <span class=nn>DataGeneration</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>System</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Types</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Set of JobTypes for iterating over and sampling from
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>jobTypes</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>        <span class=o>[|</span>
</span></span><span class=line><span class=cl>            <span class=nn>JobType</span><span class=p>.</span><span class=n>A</span>
</span></span><span class=line><span class=cl>            <span class=nn>JobType</span><span class=p>.</span><span class=n>B</span>
</span></span><span class=line><span class=cl>            <span class=nn>JobType</span><span class=p>.</span><span class=n>C</span>
</span></span><span class=line><span class=cl>            <span class=nn>JobType</span><span class=p>.</span><span class=n>D</span> <span class=c1>// The new DU case we added
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>|]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Some theoretical JobTypeSets to be used in generating
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// random Machines
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>jobTypeSets</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>[|</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span> <span class=n>jobTypes</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span> <span class=n>jobTypes</span><span class=o>[</span><span class=mi>1</span><span class=o>..]</span>
</span></span><span class=line><span class=cl>            <span class=n>Set</span> <span class=n>jobTypes</span><span class=o>[</span><span class=mi>2</span><span class=o>..]</span>
</span></span><span class=line><span class=cl>        <span class=o>|]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>minJobSize</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>maxJobSize</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>randomJobSize</span> <span class=o>(</span><span class=n>rng</span><span class=o>:</span> <span class=n>Random</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>rng</span><span class=o>.</span><span class=n>Next</span><span class=o>(</span><span class=n>minJobSize</span><span class=o>,</span> <span class=n>maxJobSize</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|&gt;</span> <span class=kt>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>randomJobType</span> <span class=o>(</span><span class=n>rng</span><span class=o>:</span> <span class=n>Random</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>jobTypes</span><span class=o>.[</span><span class=n>rng</span><span class=o>.</span><span class=n>Next</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span> <span class=n>jobTypes</span><span class=o>.</span><span class=n>Length</span><span class=o>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>randomJobTypeSet</span> <span class=o>(</span><span class=n>rng</span><span class=o>:</span> <span class=n>Random</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>jobTypeSets</span><span class=o>.[</span><span class=n>rng</span><span class=o>.</span><span class=n>Next</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span> <span class=n>jobTypeSets</span><span class=o>.</span><span class=n>Length</span><span class=o>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>randomJob</span> <span class=o>(</span><span class=n>rng</span><span class=o>:</span> <span class=n>Random</span><span class=o>)</span> <span class=o>(</span><span class=n>id</span><span class=o>:</span> <span class=n>int</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span> 
</span></span><span class=line><span class=cl>            <span class=n>Id</span> <span class=o>=</span> <span class=n>id</span>
</span></span><span class=line><span class=cl>            <span class=n>JobType</span> <span class=o>=</span> <span class=n>randomJobType</span> <span class=n>rng</span>
</span></span><span class=line><span class=cl>            <span class=n>Size</span> <span class=o>=</span> <span class=n>randomJobSize</span> <span class=n>rng</span> 
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>randomMachine</span> <span class=o>(</span><span class=n>rng</span><span class=o>:</span> <span class=n>Random</span><span class=o>)</span> <span class=o>(</span><span class=n>id</span><span class=o>:</span> <span class=n>int</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Id</span> <span class=o>=</span> <span class=n>id</span>
</span></span><span class=line><span class=cl>            <span class=n>JobTypes</span> <span class=o>=</span> <span class=n>randomJobTypeSet</span> <span class=n>rng</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=updating-our-model>Updating Our Model</h2><p>I won&rsquo;t go over all the model code that we created before. I am just going to show the new constraints that we need to add to the original formulation. One of the reasons I love Mathematical Planning is that it makes it relatively easy to tweak and update models over time. If the code is well organized, it&rsquo;s trivial to turn features on and off. To add our limits on the amount of job-type D that a machine has, let&rsquo;s define a value which is the maximum percent of D allowed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=c1>// Limit on the amount of JobType D on any given machine
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>let</span> <span class=nv>maxJobTypeDPercentage</span> <span class=o>=</span> <span class=mi>0</span><span class=o>.</span><span class=mi>30</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we want to create a constraint for each of our machines which says the the percent of the total work assigned to the machine is no more than this percentage. Fortunately, this is relatively easy with Flips.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>maxJobTypeDConstraints</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ConstraintBuilder</span> <span class=s>&#34;MaxTypeD&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>machine</span> <span class=k>in</span> <span class=n>machines</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>let</span> <span class=nv>totalWork</span> <span class=o>=</span> <span class=n>sum</span> <span class=o>(</span><span class=n>assignments</span><span class=o>[</span><span class=n>machine</span><span class=o>,</span> <span class=n>All</span><span class=o>,</span> <span class=n>All</span><span class=o>]</span> <span class=o>.*</span> <span class=n>jobSizes</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=k>let</span> <span class=nv>jobTypeDWork</span> <span class=o>=</span> <span class=n>sum</span> <span class=o>(</span><span class=n>assignments</span><span class=o>[</span><span class=n>machine</span><span class=o>,</span> <span class=nn>JobType</span><span class=p>.</span><span class=n>D</span><span class=o>,</span> <span class=n>All</span><span class=o>]</span> <span class=o>.*</span> <span class=n>jobSizes</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=n>jobTypeDWork</span> <span class=o>&lt;==</span> <span class=n>maxJobTypeDPercentage</span> <span class=o>*</span> <span class=n>totalWork</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Okay, let&rsquo;s unpack this. We are using the <code>ConstraintBuilder</code> Computation Expression to create a constraint for each <code>machine</code> in <code>machines</code>. We then calculate the total amount of work assigned to a <code>machine</code> by using the <code>assignments</code> SliceMap and selecting all the assignments for our <code>machine</code> and performing elementwise multiplication, <code>.*</code>, by the <code>jobSizes</code>. We then sum that up to get the total amount of work assigned to the <code>machine</code>. We store that expression in the <code>totalWork</code> value.</p><p>To get the total amount of job-type D work assigned to the machine, we need to sub-select the <code>assignments</code> SliceMap for the <code>machine</code> and <code>JobType.D</code> then elementwise multiply by the <code>jobSizes</code>. We sum these values up to get the <code>jobTypeDWork</code> expression. <code>totalWork</code> is an expression which represents the total amount of work assigned to the <code>machine</code>. <code>jobTypeDWork</code> represent the total amount of job-type D assigned to the <code>machine</code>.</p><p>We can now create our constraint expression. We state that <code>jobTypeDWork</code> must be less or equal to the <code>totalWork</code> expression multiplied by the max allowed percentage of job-type D, <code>maxJobTypeDPercentage</code>. This constraint will limit just how much work of job-type D that is allowed on the machine. That&rsquo;s all we must do to accommodate this new restriction from my friend.</p><h2 id=unpacking-the-results>Unpacking the Results</h2><p>The only other change my friend asked for was to increase the number of jobs up to 100 because it would be more represented of the size of the real-world problem. With that adjustment, we can now compose our new model with these new constraints included.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>model</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Model</span><span class=p>.</span><span class=n>create</span> <span class=n>minSetupsObjective</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraints</span> <span class=n>maxWorkConstraints</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraints</span> <span class=n>minWorkConstraints</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraint</span> <span class=n>maxWorkDifferenceConstraint</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraints</span> <span class=n>setupConstraints</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraints</span> <span class=n>jobsAssignmentConstraints</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Model</span><span class=p>.</span><span class=n>addConstraints</span> <span class=n>maxJobTypeDConstraints</span> <span class=c1>// Our new constraints
</span></span></span></code></pre></td></tr></table></div></div><p>We setup our solver settings and attempt to solve.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=c1>// Give the solver plenty of time to find a solution
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>let</span> <span class=nv>settings</span> <span class=o>=</span> <span class=o>{</span> <span class=nn>Settings</span><span class=p>.</span><span class=n>basic</span> <span class=k>with</span> <span class=n>MaxDuration</span> <span class=o>=</span> <span class=mi>60_000L</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>result</span> <span class=o>=</span> <span class=nn>Solver</span><span class=p>.</span><span class=n>solve</span> <span class=n>settings</span> <span class=n>model</span>
</span></span></code></pre></td></tr></table></div></div><p>We now inspect the result. We add a couple of functions for getting the job assignments for each machine and summarizing the total loading of the machines.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=c1>// This will return a list&lt;Machine * list&lt;Job&gt;&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>let</span> <span class=nv>getMachineAssignments</span> <span class=o>(</span><span class=n>solution</span><span class=o>:</span> <span class=n>Solution</span><span class=o>)</span> <span class=o>(</span><span class=n>assignments</span><span class=o>:</span> <span class=n>SMap3</span><span class=o>&lt;</span><span class=n>Machine</span><span class=o>,</span> <span class=n>JobType</span><span class=o>,</span> <span class=n>Job</span><span class=o>,</span> <span class=n>Decision</span><span class=o>&gt;)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Solution</span><span class=p>.</span><span class=n>getValues</span> <span class=n>solution</span> <span class=n>assignments</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Map</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=o>_</span> <span class=n>v</span> <span class=o>-&gt;</span> <span class=n>v</span> <span class=o>=</span> <span class=mi>1</span><span class=o>.</span><span class=mi>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>Map</span><span class=p>.</span><span class=n>toList</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=o>(</span><span class=k>fun</span> <span class=o>((</span><span class=n>machine</span><span class=o>,</span> <span class=o>_,</span> <span class=n>job</span><span class=o>),</span> <span class=o>_)</span> <span class=o>-&gt;</span> <span class=n>machine</span><span class=o>,</span> <span class=n>job</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>sortBy</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>machine</span><span class=o>,</span> <span class=n>job</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>machine</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span> <span class=n>job</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>groupBy</span> <span class=n>fst</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>machine</span><span class=o>,</span> <span class=n>jobs</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>machine</span><span class=o>,</span> <span class=n>jobs</span> <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=n>snd</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// This create an anonymous record which holds the Machine,
</span></span></span><span class=line><span class=cl><span class=c1>// the total loading and the job-type D loading
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>let</span> <span class=nv>getMachineLoading</span> <span class=n>jobAssignments</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>jobAssignments</span>
</span></span><span class=line><span class=cl>    <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>machine</span><span class=o>,</span> <span class=n>jobs</span><span class=o>)</span> <span class=o>-&gt;</span> 
</span></span><span class=line><span class=cl>        <span class=o>{|</span> <span class=n>Machine</span> <span class=o>=</span> <span class=n>machine</span>
</span></span><span class=line><span class=cl>           <span class=n>TotalWork</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>                <span class=n>jobs</span> 
</span></span><span class=line><span class=cl>                <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>sumBy</span> <span class=o>(</span><span class=k>fun</span> <span class=n>j</span> <span class=o>-&gt;</span> <span class=n>j</span><span class=o>.</span><span class=n>Size</span><span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=n>JobTypeDWork</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>                <span class=n>jobs</span> 
</span></span><span class=line><span class=cl>                <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>filter</span> <span class=o>(</span><span class=k>fun</span> <span class=n>j</span> <span class=o>-&gt;</span> <span class=n>j</span><span class=o>.</span><span class=n>JobType</span> <span class=o>=</span> <span class=nn>JobType</span><span class=p>.</span><span class=n>D</span><span class=o>)</span> 
</span></span><span class=line><span class=cl>                <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>sumBy</span> <span class=o>(</span><span class=k>fun</span> <span class=n>j</span> <span class=o>-&gt;</span> <span class=n>j</span><span class=o>.</span><span class=n>Size</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|})</span>
</span></span></code></pre></td></tr></table></div></div><p>We then use these to analyze the result and print out what we found.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>match</span> <span class=n>result</span> <span class=k>with</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>Optimal</span> <span class=n>solution</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get which jobs are assigned to each machine
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>machineAssignments</span> <span class=o>=</span> <span class=n>getMachineAssignments</span> <span class=n>solution</span> <span class=n>assignments</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Calculate the total work for each machine and the amount of job-type D
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>machineLoads</span> <span class=o>=</span> <span class=n>getMachineLoading</span> <span class=n>machineAssignments</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>printfn</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>printfn</span> <span class=s>&#34;Machine Loading:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>m</span><span class=o>)</span> <span class=k>in</span> <span class=n>machineLoads</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Print out the loading for each machine and the percent of job-type D work
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printfn</span> <span class=o>$</span><span class=s>&#34;Machine: {m.Machine.Id} | Total Work: {m.TotalWork} | Type D Work %.2f{m.JobTypeDWork / m.TotalWork} %%&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Find the min and max loads and calculate the difference
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>maxDifference</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>loads</span> <span class=o>=</span> <span class=n>machineLoads</span> <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=o>(</span><span class=k>fun</span> <span class=n>m</span> <span class=o>-&gt;</span> <span class=n>m</span><span class=o>.</span><span class=n>TotalWork</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=nn>List</span><span class=p>.</span><span class=n>max</span> <span class=n>loads</span><span class=o>)</span> <span class=o>-</span> <span class=o>(</span><span class=nn>List</span><span class=p>.</span><span class=n>min</span> <span class=n>loads</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>printfn</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>printfn</span> <span class=o>$</span><span class=s>&#34;Max Difference in Loading: { maxDifference }&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=o>_</span> <span class=o>-&gt;</span> <span class=n>printfn</span> <span class=s>&#34;%A&#34;</span> <span class=n>result</span>
</span></span></code></pre></td></tr></table></div></div><p>This will show the following results.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Machine Loading:
</span></span><span class=line><span class=cl>Machine: 1 | Total Work: 28 | Type D Work 0.00 %
</span></span><span class=line><span class=cl>Machine: 2 | Total Work: 28 | Type D Work 0.50 %
</span></span><span class=line><span class=cl>Machine: 3 | Total Work: 29 | Type D Work 0.00 %
</span></span><span class=line><span class=cl>Machine: 4 | Total Work: 30 | Type D Work 0.50 %
</span></span><span class=line><span class=cl>Machine: 5 | Total Work: 29 | Type D Work 0.00 %
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Max Difference in Loading: 2
</span></span></code></pre></td></tr></table></div></div><p>You can see that the machines are evenly loaded according to the maximum allowable difference and that no machine has more than 50% loading of job-type D. I would say that we have a success!</p><h2 id=takeaways>Takeaways</h2><p>We are only beginning to look at variations of this problem. Hopefully, what you have been able to observe was that it was simple to update our model code to add this new requirement my friend found. I think that is part of the beautify of Mathematical Planning. Updating and adjusting the logic can be simple. In our next post we are going to look at what happens when we add capacity for the machines and our problem becomes unsolvable!</p><p>Please send me an email at <a href=mailto:matthewcrews@gmail.com rel>matthewcrews@gmail.com</a> if you have any questions and subscribe so you can stay on top new posts and products I am offering.</p><script>window.mootrack||!function(e,t,n,s,o){function i(e){var s,o=~~(Date.now()/3e5),t=document.createElement(n);t.async=!0,t.src=e+"?ts="+o,s=document.getElementsByTagName(n)[0],s.parentNode.insertBefore(t,s)}e.MooTrackerObject=o,e[o]=e[o]||function(){return e[o].q?void e[o].q.push(arguments):void(e[o].q=[arguments])},window.attachEvent?window.attachEvent("onload",i.bind(this,s)):window.addEventListener("load",i.bind(this,s),!1)}(window,document,"script","https://cdn.stat-track.com/statics/moosend-tracking.min.js","mootrack"),mootrack("loadForm","b498d29aaba84b5bb3e0479003dc7264")</script><div data-mooform-id=b498d29a-aba8-4b5b-b3e0-479003dc7264></div></div><div id=comments></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.112.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=matthewcrews.com target=_blank>Matthew Crews</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>