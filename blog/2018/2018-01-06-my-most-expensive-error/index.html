<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>My Most Expensive error - Matthew Crews</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:title" content="My Most Expensive error"><meta property="og:description" content="The title for this may be a little over the top but it is not far from the truth. I am wanting to show how Units of Measure in F# can protect against some of the most insidious types of errors, mismatched units.
One of the most difficult parts of putting together algorithms has been making sure that the Units of Measure for numbers match. For example, you should not be able to add lbs and cm, it doesn&rsquo;t make sense."><meta property="og:type" content="article"><meta property="og:url" content="https://matthewcrews.com/blog/2018/2018-01-06-my-most-expensive-error/"><meta property="og:image" content="https://matthewcrews.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-01-06T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-05T00:04:47-07:00"><meta property="og:site_name" content="Matthew Crews"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://matthewcrews.com/logo.png"><meta name=twitter:title content="My Most Expensive error"><meta name=twitter:description content="The title for this may be a little over the top but it is not far from the truth. I am wanting to show how Units of Measure in F# can protect against some of the most insidious types of errors, mismatched units.
One of the most difficult parts of putting together algorithms has been making sure that the Units of Measure for numbers match. For example, you should not be able to add lbs and cm, it doesn&rsquo;t make sense."><meta name=application-name content="Mathew Crews"><meta name=apple-mobile-web-app-title content="Mathew Crews"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://matthewcrews.com/blog/2018/2018-01-06-my-most-expensive-error/><link rel=prev href=https://matthewcrews.com/blog/2018/2018-01-05-using-fsharp-to-parse-html/><link rel=next href=https://matthewcrews.com/blog/2018/2018-01-14-the-divide-operator-is-a-lie/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"My Most Expensive error","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/matthewcrews.com\/blog\/2018\/2018-01-06-my-most-expensive-error\/"},"image":[{"@type":"ImageObject","url":"https:\/\/matthewcrews.com\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"blog","wordcount":932,"url":"https:\/\/matthewcrews.com\/blog\/2018\/2018-01-06-my-most-expensive-error\/","datePublished":"2018-01-06T00:00:00+00:00","dateModified":"2023-05-05T00:04:47-07:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/matthewcrews.com\/images\/fast_fsharp_avatar.png"},"author":{"@type":"Person","name":"Matthew Crews"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">My Most Expensive error</h1><div class=content id=content><p>The title for this may be a little over the top but it is not far from the truth. I am wanting to show how Units of Measure in F# can protect against some of the most insidious types of errors, mismatched units.</p><p>One of the most difficult parts of putting together algorithms has been making sure that the Units of Measure for numbers match. For example, you should not be able to add lbs and cm, it doesn&rsquo;t make sense. In most programming languages though, a number is just a number. You may be working with a strict language which requires you to convert from <code>int</code> to <code>float</code> before multiplying, but many will do this implicitly.</p><p>When I am writing in R, Python, or C# I don&rsquo;t have any kind of Units of Measure checking. This has led to a lot of frustrating debugging in the past where I missed some simple multiplication or division in my code. These types of bugs can be really nefarious because you can often get numbers which seem sensible at first but then blow up when outlier data is introduced.</p><h2 id=the-initial-error>The Initial Error</h2><p>I was tasked with writing a simple fee calculation for our products on Amazon. We need to know the impact of the new fees on our costing before they go into effect. This is such a simple thing. On my first pass I decided to just throw something together in Python. When I did this, I made a very expensive mistake. Can you see it?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_item_fba_fee</span><span class=p>(</span><span class=n>cost_config</span><span class=p>,</span> <span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>weight_tiers</span> <span class=o>=</span> <span class=n>cost_config</span><span class=p>[</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;item_size&#39;</span><span class=p>]][</span><span class=s1>&#39;WeightTiers&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>weight_tier</span> <span class=o>=</span> <span class=p>[</span><span class=n>tier</span> <span class=k>for</span> <span class=n>tier</span> <span class=ow>in</span> <span class=n>weight_tiers</span> <span class=k>if</span>
</span></span><span class=line><span class=cl>                   <span class=p>(</span><span class=n>tier</span><span class=p>[</span><span class=s1>&#39;MinWeight&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;item_weight&#39;</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>tier</span><span class=p>[</span><span class=s1>&#39;MaxWeight&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;item_weight&#39;</span><span class=p>])][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>fee</span> <span class=o>=</span> <span class=n>weight_tier</span><span class=p>[</span><span class=s1>&#39;BaseFee&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=nb>max</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;item_weight&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>weight_tier</span><span class=p>[</span><span class=s1>&#39;weight_fee_lb_cutoff&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fee</span>
</span></span></code></pre></td></tr></table></div></div><p>This function is taking a <code>Dictionary</code>, <code>cost_config</code>, which holds some configuration values and a row of a Pandas <code>DataFrame</code>, called <code>item</code>. The first line of the function looks up the weight tiers which may apply to the <code>item</code>. It then searches through the tiers to find the <code>weight_tier</code> which matches the weight of the <code>item</code>. It then calculates the fee, which is where the error is.</p><p>The <code>fee</code> value is composed of a <code>base_fee</code>, in US Dollars (USD), and a USD/lb fee if the weight is above the <code>weight_fee_lb_cutoff</code> value. In this case the <code>weight_fee_lb_cutoff</code> value is 2.0 lbs. So, for every lb over 2.0, the item is charged an additional fee per lb.</p><p>You may see the error now, I never multiply the overage weight by the <code>[USD/lb]</code>, (US Dollars / pound), fee rate. If you look at the units of the fee calculation I am adding the <code>base_fee</code>, which is in <code>[USD]</code>, to <code>[lbs]</code>. That does not make any sense. You can&rsquo;t add different types of units, but most languages will let you do this all day. This was insidious because for most of our items, the fee was right. Only in cases where the item was over 2.0 <code>[lbs]</code> did we get an incorrect fee.</p><p>I&rsquo;ll be honest, I didn&rsquo;t actually catch this bug. I put this code in production but I never felt really good about it. I couldn&rsquo;t explain it but there was disquiet in my soul. I was already starting to rewrite parts of our system in F# so I decided that I would rewrite this little piece while it was fresh in my mind.</p><h2 id=f-units-of-measure-save-the-day>F# Units of Measure Save the Day</h2><p>For the last several years I have been moving toward more and more strict programming languages. When I heard that F# allows you to put Units of Measure on your numbers, I fell in love. I have longed for such a feature. So many errors can be eliminated when dealing with numbers if you can track and enforce units alignment in numbers.</p><p>Because my soul never settled with my initial Python solution, I decided to rewrite the fee calculation. When I started I immediately declared the Units of Measure that I would need:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=c1>// Units of Measure Types
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>[&lt;</span><span class=n>Measure</span><span class=o>&gt;]</span> <span class=k>type</span> <span class=nc>USD</span> <span class=c>(* US Dollar *)</span>
</span></span><span class=line><span class=cl><span class=o>[&lt;</span><span class=n>Measure</span><span class=o>&gt;]</span> <span class=k>type</span> <span class=nc>lb</span> <span class=c>(* Imperial pound *)</span>
</span></span></code></pre></td></tr></table></div></div><p>I then wrote my fee calculation with the Units of Measure on the numbers to ensure everything matched. I then immediately saw the mistake. You will notice in this new function that I do multiply by the <code>feeRate</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=c1>// New fee function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>let</span> <span class=nv>calculateWeightFee</span> <span class=o>(</span><span class=n>baseFee</span> <span class=o>:</span> <span class=kt>decimal</span><span class=o>&lt;</span><span class=n>USD</span><span class=o>&gt;)</span> <span class=o>(</span><span class=n>weightFeeCutoff</span> <span class=o>:</span> <span class=kt>decimal</span><span class=o>&lt;</span><span class=n>lb</span><span class=o>&gt;)</span> 
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=n>feeRate</span> <span class=o>:</span> <span class=kt>decimal</span><span class=o>&lt;</span><span class=n>USD</span><span class=o>/</span><span class=n>lb</span><span class=o>&gt;)</span> <span class=o>(</span><span class=n>weight</span> <span class=o>:</span> <span class=kt>decimal</span><span class=o>&lt;</span><span class=n>lb</span><span class=o>&gt;)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>baseFee</span> <span class=o>+</span> <span class=o>(</span><span class=n>max</span> <span class=mi>0M</span><span class=o>&lt;</span><span class=n>lb</span><span class=o>&gt;</span> <span class=o>(</span><span class=n>weight</span> <span class=o>-</span> <span class=n>weightFeeCutoff</span><span class=o>))</span> <span class=o>*</span> <span class=n>feeRate</span>
</span></span></code></pre></td></tr></table></div></div><p>I felt pretty stupid after such an obvious mistake. Fortunately, the previous version of the code was only in production for a couple of days. Had this gone on for longer, we could have missed huge volumes of opportunity because products would have look too expensive due to the new fee.</p><p>Now granted, better unit testing would have caught this. Also, this post is not meant to disparage Python, or any other language, in any way. Rather, I am highlighting that F# is eliminating an entire class of errors for me and making me more productive. I much prefer the compiler barking at me about my units not matching than me spending hours or days hunting for where I missed a multiplication or a division. It feels great knowing that my units line up and that if I miss a small detail like this, the compiler will gently guide me back to sanity. Check out this wonderful <a href=https://fsharpforfunandprofit.com/posts/units-of-measure/ target=_blank rel="noopener noreffer">post by Scott Wlaschin</a> for a more detailed discussion on what can be done with F# and Units of Measure.</p></div><div id=comments></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=matthewcrews.com target=_blank>Matthew Crews</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>