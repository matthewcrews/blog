<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Why I Love F# for Mathematical Planning - Matthew Crews</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:title" content="Why I Love F# for Mathematical Planning">
<meta property="og:description" content="A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take away
Antoine de Saint-Exupery On my journey of growing as a developer, I am consistently inspired by language features which seem incredibly simple but yield remarkable benefit. As I try to master F#, I am frequently surprised by how powerful the language is for expressing ideas while having so few features."><meta property="og:type" content="article"><meta property="og:url" content="https://matthewcrews.com/blog/2020/12/2020-12-09/"><meta property="og:image" content="https://matthewcrews.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-12-09T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-17T00:21:52-08:00"><meta property="og:site_name" content="Matthew Crews"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://matthewcrews.com/logo.png"><meta name=twitter:title content="Why I Love F# for Mathematical Planning"><meta name=twitter:description content="A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take away
Antoine de Saint-Exupery On my journey of growing as a developer, I am consistently inspired by language features which seem incredibly simple but yield remarkable benefit. As I try to master F#, I am frequently surprised by how powerful the language is for expressing ideas while having so few features."><meta name=twitter:site content="@xxxx"><meta name=application-name content="Mathew Crews"><meta name=apple-mobile-web-app-title content="Mathew Crews"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://matthewcrews.com/blog/2020/12/2020-12-09/><link rel=prev href=https://matthewcrews.com/blog/2020/12/2020-12-07/><link rel=next href=https://matthewcrews.com/blog/2020/12/2020-12-14/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Why I Love F# for Mathematical Planning","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/matthewcrews.com\/blog\/2020\/12\/2020-12-09\/"},"image":[{"@type":"ImageObject","url":"https:\/\/matthewcrews.com\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"blog","wordcount":1805,"url":"https:\/\/matthewcrews.com\/blog\/2020\/12\/2020-12-09\/","datePublished":"2020-12-09T00:00:00+00:00","dateModified":"2023-12-17T00:21:52-08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/matthewcrews.com\/images\/fast_fsharp_avatar.png"},"author":{"@type":"Person","name":"Matthew Crews"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Matthew Crews">Matthew Crews</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/matthewcrews/blog title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">Why I Love F# for Mathematical Planning</h1><div class=content id=content><blockquote><p>A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take away</p><ul><li>Antoine de Saint-Exupery</li></ul></blockquote><p>On my journey of growing as a developer, I am consistently inspired by language features which seem incredibly simple but yield remarkable benefit. As I try to master F#, I am frequently surprised by how powerful the language is for expressing ideas while having so few features. Discussions frequently pop up about the need for ever more powerful abstractions, yet I find myself amazed by how far you can take the language with what is already there.</p><p>I am no programming language expert, but I admire languages that maintain a lean feature set. Every new feature added to a language makes it just a little bit more difficult to fully understand and a little more intimidating for new developers. It is an impressive design feat when a language can remain approachable for beginners but enable the flexibility that library authors need.</p><p>I am an Industrial Engineering turned Machine Learning Engineer, and I focus on the problem of maximizing the profitability and efficiency of companies. Often the solution involves a Mathematical Planning Model (aka Mathematical Programming). What I hope to do in the next few paragraphs is illustrate to you how some of the most basic features of F#, Discriminated Unions and Units of Measure, eliminate the most pernicious bugs when developing these models.</p><h2 id=the-domain-of-mathematical-planning>The Domain of Mathematical Planning</h2><p>The domain of Mathematical Planning is made up of Decisions, Constraints, and Objectives. A Decision is a choice that a business needs to make. It can be how many of Item X do we buy, do we build in Location A or Location B, or how many people do we assign to each job. Constraints are the rules we need to abide by. They are the limitations on what is possible. A Constraint could be that we only have 10 people available, or we can only build in Seattle or Portland, or we only have $1,000,000 to invest. The Objective is how we measure success. It is the function we want to maximize or minimize. We could minimize waste, maximize profit, or minimize cost.</p><p>Many of my colleagues are building their models with Python. Python is a great language and I have been productive with it in the past. Here is a snippet of what a mathematical planning model may look like in Python:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Define a list of items to optimize for</span>
</span></span><span class=line><span class=cl><span class=n>items</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>,</span> <span class=s2>&#34;C&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define a list of locations to assign items to</span>
</span></span><span class=line><span class=cl><span class=n>locations</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;Portland&#34;</span><span class=p>,</span> <span class=s2>&#34;Seattle&#34;</span><span class=p>,</span> <span class=s2>&#34;Detroit&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define a dictionary of revenue associated with each item and location tuple</span>
</span></span><span class=line><span class=cl><span class=n>revenue</span> <span class=o>=</span> <span class=p>{(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span><span class=s2>&#34;Portland&#34;</span><span class=p>):</span><span class=mf>1.5</span><span class=p>;,</span> <span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span><span class=s2>&#34;Seattle&#34;</span><span class=p>):</span><span class=mf>1.7</span> <span class=o>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define a dictionary with the availability of each item</span>
</span></span><span class=line><span class=cl><span class=n>availability</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;A&#34;</span><span class=p>:</span><span class=mf>10.0</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>:</span><span class=mf>20.0</span><span class=p>,</span> <span class=s2>&#34;C&#34;</span><span class=p>:</span><span class=mf>14.0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a Decision for each Item, Location combination. This will be how much</span>
</span></span><span class=line><span class=cl><span class=c1># of a given item we decide to send to that location</span>
</span></span><span class=line><span class=cl><span class=n>allocation</span> <span class=o>=</span> <span class=n>LpVariable</span><span class=o>.</span><span class=n>dicts</span><span class=p>(</span><span class=s2>&#34;AmountSent&#34;</span><span class=p>,(</span><span class=n>items</span><span class=p>,</span><span class=n>locations</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create an instance of a `Problem` object and state that we want to maximize</span>
</span></span><span class=line><span class=cl><span class=c1># the objective we give it</span>
</span></span><span class=line><span class=cl><span class=n>problem</span> <span class=o>=</span> <span class=n>LpProblem</span><span class=p>(</span><span class=s2>&#34;ItemAllocation&#34;</span><span class=p>,</span> <span class=n>LpMaximize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We create an expression which evaluates the total revenue</span>
</span></span><span class=line><span class=cl><span class=n>revenue_expr</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>lpSum</span><span class=p>([</span><span class=n>revenue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>l</span><span class=p>]</span> <span class=o>*</span> <span class=n>allocation</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>l</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>items</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>locations</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We set the Objective of the Problem by adding it</span>
</span></span><span class=line><span class=cl><span class=n>problem</span> <span class=o>+=</span> <span class=n>revenue_expr</span><span class=p>,</span> <span class=s2>&#34;MaximizeRevenue&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># For each item in items, create a constraint which states that the total number</span>
</span></span><span class=line><span class=cl><span class=c1># of items that is allocated cannot exceed the availability of the item</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>problem</span> <span class=o>+=</span> <span class=n>lpSum</span><span class=p>([</span><span class=n>allocation</span><span class=p>[</span><span class=n>l</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>location</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>availability</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>This is the beginning of a straightforward assignment problem. We have a list of items, <code>items</code>. For each <code>item</code> in <code>items</code>, we must decide how many we send to each <code>location</code> in <code>locations</code>. There is a limit on how much of each <code>item</code> is available for us to send. There is a revenue associated with sending a particular <code>item</code> to a given <code>location</code>. In this problem we want to maximize our revenue which is calculated by multiplying the <code>decision</code> for a given <code>item</code> and <code>location</code> by the <code>revenue</code> associated with it. Finally, we create a constraint for each <code>item</code> in <code>items</code> which states that the total number of a given <code>item</code> that is allocated cannot exceed the total that is available.</p><p>This is only part of the problem. Normally there would be more constraints that would make it more interesting. This is enough of a problem to illustrate my case though. There are two errors in this model already. If you were paying close attention you may have found one. I promise you cannot detect the second.</p><h2 id=the-power-of-domain-modeling-using-discriminated-unions>The Power of Domain Modeling Using Discriminated Unions</h2><p>F# provides two simple but powerful features which help ensure against the errors in the Python code. The first is Discriminated Unions. If we were to reformulate this problem using F#, the first thing we would do was define some simple types to model our domain.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>type</span> <span class=nc>Item</span> <span class=o>=</span> <span class=n>Item</span> <span class=k>of</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=k>type</span> <span class=nc>Location</span> <span class=o>=</span> <span class=n>Location</span> <span class=k>of</span> <span class=kt>string</span>
</span></span></code></pre></td></tr></table></div></div><p>Instead of just using strings to describe our Items and Locations, we create simple, single case Discriminated Unions (DU). These DUs provide context around what the strings are meant to represent. Let&rsquo;s go ahead and create our <code>item</code> and <code>locations</code> lists again. This time, wrapping them in DUs.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>items</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=o>[</span><span class=s>&#34;A&#34;</span><span class=o>;</span> <span class=s>&#34;B&#34;</span><span class=o>;</span> <span class=s>&#34;C&#34;</span><span class=o>]</span> 
</span></span><span class=line><span class=cl>  <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=n>Item</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>locations</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>  <span class=o>[</span><span class=s>&#34;Portland&#34;</span><span class=o>;</span> <span class=s>&#34;Seattle&#34;</span><span class=o>;</span> <span class=s>&#34;Detroit&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=n>Location</span>
</span></span></code></pre></td></tr></table></div></div><p>We will also update our <code>availability</code> information to use these new types.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>availability</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;A&#34;</span><span class=o>,</span> <span class=n>10</span><span class=o>.</span><span class=n>0</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;B&#34;</span><span class=o>,</span> <span class=n>20</span><span class=o>.</span><span class=n>0</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;C&#34;</span><span class=o>,</span> <span class=n>14</span><span class=o>.</span><span class=n>0</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span> <span class=o>|&gt;</span> <span class=n>Map</span>
</span></span></code></pre></td></tr></table></div></div><p>We will create the Decisions for each <code>item</code> and <code>location</code>. We store these <code>Decision</code> types in a <code>Map</code> which is indexed by an <code>(Item * Location)</code> tuple.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>allocation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>DecisionBuilder</span><span class=o>&lt;</span><span class=n>Servings</span><span class=o>&gt;</span> <span class=s>&#34;AmountSent&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>items</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>l</span> <span class=k>in</span> <span class=n>locations</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=n>Continuous</span> <span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=n>0</span><span class=o>,</span> <span class=n>infinity</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=o>|&gt;</span> <span class=n>Map</span>
</span></span></code></pre></td></tr></table></div></div><p>We now attempt to create the same constraints we did in Python with a direct translation.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>allocationContraints</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ConstraintBuilder</span> <span class=s>&#34;ItemLimit&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>items</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nn>List</span><span class=p>.</span><span class=n>sum</span> <span class=o>[</span><span class=k>for</span> <span class=n>l</span> <span class=k>in</span> <span class=n>locations</span> <span class=o>-&gt;</span> <span class=n>1</span><span class=o>.</span><span class=n>0</span> <span class=o>*</span> <span class=n>allocation</span><span class=o>[</span><span class=n>l</span><span class=o>,</span> <span class=n>i</span><span class=o>]]</span> <span class=o>&lt;==</span> <span class=n>availability</span><span class=o>.[</span><span class=n>i</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>   
</span></span></code></pre></td></tr></table></div></div><p>Except, the compiler is gives us an error on the indexing of <code>allocation</code>.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/2020-12-08-indexing-error.png data-srcset="/img/2020-12-08-indexing-error.png, /img/2020-12-08-indexing-error.png 1.5x, /img/2020-12-08-indexing-error.png 2x" data-sizes=auto alt=/img/2020-12-08-indexing-error.png title="Compiler error for indexing Map"></p><p>What some of you may have noticed in the Python code is that the <code>allocation</code> collection is indexed by an <code>Item</code> then <code>Location</code>. The original code was trying to access it by <code>location</code> then by <code>item</code>. This would have thrown an error at runtime due to a missing value. In F# this becomes a compiler error. The type system itself it is helping you. This may seem small, but this is one of the most painful types of errors when debugging a Mathematical Planning model.</p><p>Someone may say that this can be accomplished in other languages and I would agree. I believe where F# is unique is in the simplicity and ease of using single case Discriminated Unions for wrapping primitives. It is virtually no additional effort.</p><h2 id=units-of-measure-the-achilles-heel-of-numbers>Units of Measure: The Achilles Heel of Numbers</h2><p>There is an underappreciated problem in software development, numbers are rarely just numbers. They represent something: <code>cm</code>, <code>feet</code>, <code>kg</code>, or <code>meters</code>. Normally we do not care about a raw number. Our primary concern is with what the number represents. In most languages there are no easy mechanisms for tracking the Units of Measure associated with a number. F# on the other hand has baked the concept of a Unit of Measure into the type system.</p><p>The Units of Measure feature will reveal the second problem with the Python code that otherwise may remain undetected. Let&rsquo;s update our domain with some new types to track the units on our numbers.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=o>[&lt;</span><span class=n>Measure</span><span class=o>&gt;]</span> <span class=k>type</span> <span class=nc>Servings</span>
</span></span><span class=line><span class=cl><span class=o>[&lt;</span><span class=n>Measure</span><span class=o>&gt;]</span> <span class=k>type</span> <span class=nc>Kg</span>
</span></span></code></pre></td></tr></table></div></div><p>We now have units to represent <code>Servings</code> and <code>Kg</code>. Let&rsquo;s update our <code>availability</code> collection to store numbers with these units attached.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>availability</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;A&#34;</span><span class=o>,</span> <span class=n>10</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;B&#34;</span><span class=o>,</span> <span class=n>20</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;C&#34;</span><span class=o>,</span> <span class=n>14</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span> <span class=o>|&gt;</span> <span class=n>Map</span>
</span></span></code></pre></td></tr></table></div></div><p>We have now provided more context around our availability numbers. We now know they are stored in units of <code>Kg</code>. The F# compiler will enforce correct algebra as we work with them. We now update our Decisions to be in units of <code>Servings</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>allocation</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>DecisionBuilder</span><span class=o>&lt;</span><span class=n>Servings</span><span class=o>&gt;</span> <span class=s>&#34;AmountSent&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>items</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>l</span> <span class=k>in</span> <span class=n>locations</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=n>Continuous</span> <span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Servings</span><span class=o>&gt;,</span> <span class=n>1_000_000</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Servings</span><span class=o>&gt;)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=o>|&gt;</span> <span class=n>Map</span>
</span></span></code></pre></td></tr></table></div></div><p>With our Decisions updated, we go back to our constraint definition and we now see a new bug.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/img/2020-12-08-units-of-measure-mismatch.png data-srcset="/img/2020-12-08-units-of-measure-mismatch.png, /img/2020-12-08-units-of-measure-mismatch.png 1.5x, /img/2020-12-08-units-of-measure-mismatch.png 2x" data-sizes=auto alt=/img/2020-12-08-units-of-measure-mismatch.png title="Units of Measure Mismatch"></p><p>The important part of this message is at the bottom. The compiler is complaining that the left-hand is in units of <code>Servings</code> and the right-hand side is in units of <code>Kg</code>. It does not make sense to compare values that are in different units, so the compiler is throwing an error. In other languages this error would go undetected. Worse, it may not even be caught in unit testing because the math will still work, it just won&rsquo;t give correct results.</p><p>Let&rsquo;s go ahead and add some conversion data so that we can fix this.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>itemMass</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;A&#34;</span><span class=o>,</span> <span class=n>1</span><span class=o>.</span><span class=n>1</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>/</span><span class=n>Servings</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;B&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>.</span><span class=n>0</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>/</span><span class=n>Servings</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>Item</span> <span class=s>&#34;C&#34;</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=n>7</span><span class=o>&lt;</span><span class=n>Kg</span><span class=o>/</span><span class=n>Servings</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span> <span class=o>|&gt;</span> <span class=n>Map</span>
</span></span></code></pre></td></tr></table></div></div><p>We now have data which will allow us to convert from <code>Serving</code> to <code>Kg</code>. Let&rsquo;s incorporate it into our constraint creation expression.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>allocationContraints</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=n>ConstraintBuilder</span> <span class=s>&#34;ItemLimit&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=n>items</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nn>List</span><span class=p>.</span><span class=n>sum</span> <span class=o>[</span><span class=k>for</span> <span class=n>l</span> <span class=k>in</span> <span class=n>locations</span> <span class=o>-&gt;</span> <span class=n>itemMass</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>*</span> <span class=n>itemAllocation</span><span class=o>[</span><span class=n>i</span><span class=o>,</span> <span class=n>l</span><span class=o>]]</span> <span class=o>&lt;==</span> <span class=n>availability</span><span class=o>[</span><span class=n>i</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span> 
</span></span></code></pre></td></tr></table></div></div><p>Now the compiler is happy because the units are in <code>Kg</code> on both sides. This simple feature of ensuring correct Units of Measure eliminates what is possibly the most nefarious bug in Mathematical Planning. It would be hard to calculate the number of hours wasted on badly formulated models due to mismatched Units of Measure.</p><h2 id=simple-building-blocks>Simple Building Blocks</h2><p>F# is an incredibly expressive language while staying lean on the number of features. Other languages have taken the approach of throwing every possible feature in. F# is relatively slow to incorporate new features and they are always purposeful. Most of the time the feature is orthogonal to the rest of the language. This is keeping the language approachable for newcomers so the climb to mastery is not nearly as steep. I believe these two simple features, Discriminated Unions and Units of Measure, uniquely position F# as an awesome language for Mathematical Planning.</p></div><div id=comments></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.121.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=matthewcrews.com target=_blank>Matthew Crews</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>